<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TD 1 Interactif : La Paie, Acte Managérial et Outil Stratégique</title>
    <!-- Chargement des librairies externes via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!--
    Plan de la structure de l'application :
    L'application est conçue comme un tableau de bord interactif avec trois sections thématiques :
    1) Un "Décortiqueur de Paie" pour disséquer visuellement le bulletin de paie.
    2) Un "Cadre Légal" avec une pyramide interactive pour la hiérarchie des normes.
    3) Une section "Enjeux Stratégiques" utilisant des cartes interactives pour explorer des concepts clés.
    Cette structure a été choisie pour transformer un TD linéaire en une expérience d'apprentissage non linéaire et plus engageante.
    -->
    <style>
        /* Styles personnalisés pour améliorer l'esthétique et l'interactivité */
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* gray-50 */
            color: #1f2937; /* gray-800 */
        }
        .nav-link {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active, .nav-link:hover {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #1d4ed8; /* blue-700 */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .pyramid-level {
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(10% 0, 90% 0, 100% 100%, 0% 100%);
            margin-bottom: -1px; /* Pour superposer légèrement les niveaux */
        }
        .pyramid-level:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        .payslip-row {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border-radius: 0.25rem;
        }
        .payslip-row:hover, .payslip-row.selected {
            background-color: #eef2ff; /* indigo-100 */
        }
        .payslip-header {
            background-color: #f3f4f6; /* gray-100 */
            font-weight: 600;
        }
        .payslip-subheader {
            background-color: #fafafa;
            font-weight: 600;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, padding 0.5s ease-out;
        }
    </style>
</head>
<body class="antialiased">

    <!-- En-tête de navigation -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-30 shadow-sm">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <h1 class="text-xl font-bold text-gray-800">TD 1 Interactif</h1>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#explorer" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-600">Décortiqueur de Paie</a>
                        <a href="#framework" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-600">Cadre Légal</a>
                        <a href="#stakes" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-600">Enjeux Stratégiques</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <div class="text-center mb-16">
             <h2 class="text-3xl sm:text-4xl font-bold tracking-tight text-gray-900">La Paie : Acte Managérial et Outil Stratégique</h2>
            <p class="mt-4 max-w-3xl mx-auto text-lg text-gray-600">Une exploration interactive pour transformer un document complexe en un puissant outil de management.</p>
        </div>

        <!-- Section 1: Décortiqueur de Bulletin de Paie -->
        <section id="explorer" class="my-20 scroll-mt-20">
            <h3 class="text-2xl font-bold text-center mb-10 text-gray-800">Le Décortiqueur de Bulletin de Paie</h3>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                <div class="card p-4 sm:p-6 lg:col-span-3">
                    <div id="payslip-container" class="text-xs sm:text-sm overflow-x-auto">
                        <!-- Le tableau interactif du bulletin de paie sera injecté ici par JavaScript -->
                    </div>
                </div>
                <div class="lg:col-span-2 lg:sticky top-24 space-y-6">
                    <div class="card p-6">
                         <h4 class="font-bold text-lg mb-2 text-gray-700">Explication de la ligne</h4>
                         <p id="explanation-box" class="text-gray-600 min-h-[120px]">Cliquez sur une ligne du bulletin de paie pour afficher son explication ici.</p>
                    </div>
                    <div class="card p-6">
                        <h4 class="font-bold text-lg mb-4 text-center text-gray-700">Du Coût Total au Net Payé</h4>
                        <div class="chart-container" style="position: relative; height:300px; width:100%;">
                            <canvas id="payslipChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Cadre Légal -->
        <section id="framework" class="my-20 scroll-mt-20">
            <h3 class="text-2xl font-bold text-center mb-12 text-gray-800">Le Cadre Légal : La Hiérarchie des Normes</h3>
            <div class="flex flex-col md:flex-row gap-8 items-center">
                <div id="pyramid-container" class="w-full md:w-1/2 flex flex-col items-center">
                    <!-- La pyramide des normes sera injectée ici par JavaScript -->
                </div>
                <div class="w-full md:w-1/2">
                    <div class="card p-6 min-h-[300px] flex flex-col justify-center">
                        <h4 class="font-bold text-lg mb-2 text-gray-700">Détail du niveau</h4>
                        <p id="pyramid-explanation" class="text-gray-600">Survolez un niveau de la pyramide pour en savoir plus.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Enjeux Stratégiques -->
        <section id="stakes" class="my-20 scroll-mt-20">
            <h3 class="text-2xl font-bold text-center mb-10 text-gray-800">Les Enjeux Stratégiques de la Paie</h3>
            <div id="accordion-container" class="space-y-4 max-w-4xl mx-auto">
                 <!-- L'accordéon interactif sera injecté ici par JavaScript -->
            </div>
        </section>
    </main>

    <footer class="bg-white border-t border-gray-200 mt-16">
        <div class="container mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-gray-500">
            <p>Application interactive basée sur le TD 1 "Pratique de la Paie".</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- 1. DÉFINITION DES DONNÉES ---
            // Toutes les données textuelles et chiffrées sont centralisées ici pour une maintenance facile.
            const payslipData = {
                header: {
                    employer: { id: 'employer', label: 'Employeur', value: 'ENTREPRISE ABC - 12 rue de la Paix, 75001 Paris', explanation: 'Identification légale de l\'employeur, incluant son nom et son adresse.' },
                    siret: { id: 'siret', label: 'Siret', value: '123 456 789 00012', explanation: 'Le numéro SIRET est un identifiant unique à 14 chiffres qui identifie chaque établissement d\'une entreprise.' },
                    ape: { id: 'ape', label: 'Code APE', value: '6201Z', explanation: 'Le code APE (Activité Principale Exercée) est attribué par l\'INSEE à des fins statistiques.' },
                    urssaf: { id: 'urssaf', label: 'URSSAF', value: 'Paris (75)', explanation: 'Organisme de recouvrement des cotisations sociales.' },
                    employee: { id: 'employee', label: 'Salarié(e)', value: 'M. Jean Dupont', explanation: 'Nom et prénom du salarié.' },
                    ssn: { id: 'ssn', label: 'N° Sécurité Sociale', value: '1 85 01 75 123 456', explanation: 'Numéro d\'inscription au répertoire des personnes physiques (NIR), clé d\'identification pour la protection sociale.' },
                    job: { id: 'job', label: 'Emploi', value: 'Développeur Web', explanation: 'Intitulé du poste occupé par le salarié.' },
                    classification: { id: 'classification', label: 'Classification', value: 'Cadre, Pos. 2.2, Coeff. 130', explanation: 'Positionnement du salarié dans la grille de la convention collective, déterminant souvent le salaire minimum.' },
                    period: { id: 'period', label: 'Période', value: '01/05/2025 au 31/05/2025', explanation: 'Période de travail correspondant à la rémunération.' }
                },
                rows: [
                    { id: 'brut_header', type: 'subheader', label: 'Salaire Brut'},
                    { id: 'base_salary', label: 'Salaire de base', base: '151,67', rate: '19,779', gain: 3000.00, explanation: 'Rémunération fixe pour le nombre d\'heures contractuelles (151,67h pour 35h/semaine). C\'est le produit du nombre d\'heures par le taux horaire.' },
                    { id: 'brut', type: 'header', label: 'Total Brut', gain: 3000.00, explanation: 'Somme de toutes les rémunérations avant déduction des cotisations salariales. C\'est la base de calcul principale.'},
                    
                    { id: 'sante_header', type: 'subheader', label: 'Santé'},
                    { id: 'secu_maladie', label: 'Sécurité sociale - Maladie Maternité Invalidité Décès', base: '3000,00', rate_s: '0,00%', rate_p: '13,00%', gain: null, deduction_s: 0, deduction_p: 390.00, explanation: 'Cotisation finançant les prestations de l\'Assurance Maladie. Pour les salaires inférieurs à 2,5 SMIC, la part salariale est supprimée, mais la part patronale reste due.' },
                    { id: 'comp_sante', label: 'Complémentaire santé (Mutuelle)', base: '3000,00', rate_s: '1,00%', rate_p: '1,00%', gain: null, deduction_s: 30.00, deduction_p: 30.00, explanation: 'Finance le remboursement complémentaire des frais de santé. La participation de l\'employeur est un avantage pour le salarié.' },
                    
                    { id: 'retraite_header', type: 'subheader', label: 'Retraite'},
                    { id: 'secu_plaf', label: 'Sécurité sociale plafonnée', base: '3000,00', rate_s: '6,90%', rate_p: '8,55%', gain: null, deduction_s: 207.00, deduction_p: 256.50, explanation: 'Cotisation pour la retraite de base, calculée sur la partie du salaire inférieure au Plafond de la Sécurité Sociale (PSS).' },
                    { id: 'secu_deplaf', label: 'Sécurité sociale déplafonnée', base: '3000,00', rate_s: '0,40%', rate_p: '1,90%', gain: null, deduction_s: 12.00, deduction_p: 57.00, explanation: 'Cotisation pour la retraite de base, calculée sur la totalité du salaire brut.' },
                    { id: 'ret_comp_t1', label: 'Complémentaire Tranche 1', base: '3000,00', rate_s: '3,15%', rate_p: '4,72%', gain: null, deduction_s: 94.50, deduction_p: 141.60, explanation: 'Cotisation pour la retraite complémentaire (Agirc-Arrco) sur la partie du salaire inférieure au PSS.' },

                    { id: 'chomage_header', type: 'subheader', label: 'Autres contributions dues par l\'employeur'},
                    { id: 'chomage_cot', label: 'Assurance chômage', base: '3000,00', rate_p: '4,05%', deduction_p: 121.50, explanation: 'Contribution exclusivement patronale finançant le régime d\'assurance chômage.' },

                    { id: 'net_social', type: 'header', label: 'Montant net social', gain: 2656.50, explanation: 'Montant de référence à déclarer pour bénéficier de certaines prestations sociales (Prime d\'activité, RSA). Il est calculé à partir du salaire brut après déduction de certaines cotisations spécifiques.' },

                    { id: 'csg_crds_header', type: 'subheader', label: 'CSG / CRDS'},
                    { id: 'csg_deduct', label: 'CSG déductible de l\'impôt', base: '2955,00', rate_s: '6,80%', deduction_s: 200.94, explanation: 'Contribution Sociale Généralisée. Cette partie est déductible du revenu imposable, diminuant ainsi la base de calcul de l\'impôt.'},
                    { id: 'csg_nondeduct', label: 'CSG/CRDS non déductible de l\'impôt', base: '2955,00', rate_s: '2,90%', deduction_s: 85.70, explanation: 'Cette partie de la CSG et la CRDS (Contribution au Remboursement de la Dette Sociale) ne sont pas déductibles du revenu imposable.'},
                    
                    { id: 'net_imposable', type: 'header', label: 'Net imposable', gain: 2680.36, explanation: 'Base sur laquelle est calculé l\'impôt sur le revenu. Il correspond au salaire brut moins les cotisations salariales déductibles.' },

                    { id: 'allegements_header', type: 'subheader', label: 'Allègements de cotisations employeur'},
                    { id: 'reduction_gen', label: 'Réduction générale', gain: 178.10, explanation: 'Aussi appelée "Zéro cotisation Urssaf", c\'est une réduction des cotisations patronales pour les salaires inférieurs à 1,6 SMIC. Elle vise à diminuer le coût du travail.' }
                ],
                footer: {
                    total_salarial: {id: 'total_salarial', value: 620.14},
                    total_patronal: {id: 'total_patronal', value: 818.50},
                    net_avant_impot: {id: 'net_avant_impot', value: 2379.86, explanation: 'Le salaire net avant impôt est le résultat du salaire brut moins le total des cotisations salariales. C\'est ce que le salarié toucherait si l\'impôt n\'était pas prélevé à la source.' },
                    pas: {id: 'pas', taux: '9,00 %', base: '2 680,36 €', montant: 241.23, explanation: 'Prélèvement à la Source de l\'impôt sur le revenu. Le montant est calculé en appliquant le taux personnalisé (communiqué par l\'administration fiscale) à la base du net imposable.'},
                    net_a_payer: {id: 'net_a_payer', value: 2138.63, explanation: 'Le net à payer est le montant final qui sera versé sur le compte bancaire du salarié. C\'est le net avant impôt moins le prélèvement à la source.'},
                    cout_total: {id: 'cout_total', value: 3640.40, explanation: 'Le coût total pour l\'employeur est la somme du salaire brut et des cotisations patronales, après déduction des allègements de charges. C\'est le coût réel du salarié pour l\'entreprise.'},
                    conges: {id: 'conges', acquis: '2.08', pris: '0', solde: '15.00', explanation: 'Suivi des droits à congés payés du salarié, en jours ouvrés ou ouvrables.'},
                }
            };
            
            const pyramidLevels = [
                { id: 'const', label: 'Bloc de constitutionnalité', color: 'bg-gray-800', text: 'Niveau suprême. Il inclut la Constitution et les principes fondamentaux. <strong>Exemple concret :</strong> Le principe "à travail égal, salaire égal" entre les femmes et les hommes, qui interdit toute discrimination salariale.'},
                { id: 'conv', label: 'Bloc de conventionalité', color: 'bg-gray-700', text: 'Sources internationales et européennes. <strong>Exemple concret :</strong> Une directive européenne imposant un temps de repos minimal de 11 heures consécutives par jour s\'applique à toutes les entreprises françaises.'},
                { id: 'loi', label: 'Loi (Sources étatiques)', color: 'bg-gray-600', text: 'Le Code du Travail, les lois et les décrets. <strong>Exemple concret :</strong> La loi qui fixe le montant du SMIC (Salaire Minimum Interprofessionnel de Croissance) que personne ne peut gagner en dessous pour un temps plein.'},
                { id: 'coll', label: 'Sources professionnelles négociées', color: 'bg-slate-500', text: 'Conventions collectives et accords de branche, de groupe ou d\'entreprise. <strong>Exemple concret :</strong> La convention collective de la Métallurgie qui prévoit une prime d\'ancienneté calculée en pourcentage du salaire minimum conventionnel.'},
                { id: 'autres_prof', label: 'Autres sources', color: 'bg-slate-400', text: 'Le contrat de travail, les usages, les engagements unilatéraux. <strong>Exemple concret :</strong> Un contrat de travail qui stipule que le salarié bénéficiera d\'une voiture de fonction, avantage qui n\'est pas prévu par la loi ou la convention collective.'}
            ];

            const accordionData = [
                { title: "Annexe 1 : La rémunération, enjeu stratégique et managérial", content: "Attirer, fidéliser et motiver ses collaborateurs sont les trois objectifs principaux des politiques de rémunération. [...] La rémunération est l’un des seuls outils managériaux ayant un impact aussi fort sur les collaborateurs et leur environnement de travail. Elle agit sur la motivation, la performance, la satisfaction, la reconnaissance, la fidélisation, l’engagement, le développement des compétences, le climat social, la marque employeur [...]. La gestion des rémunérations est donc un enjeu de premier ordre pour une organisation." },
                { title: "Annexe 2 : La feuille de paie, entre simplification et complexité persistante", content: "Pour près de trois quarts des salariés, la lecture de la feuille de paie est un véritable casse-tête. C'est pour simplifier ce document et le rendre plus compréhensible que le gouvernement a décidé d'alléger sa présentation. [...] Malgré tout, près de la moitié des Français estiment que leur bulletin de paie n’est toujours pas plus simple à déchiffrer." },
                { title: "Annexes 4 & 5 : Les risques de l'externalisation", content: "L’externalisation peut s’avérer décevante. [...] La perte de contrôle sur les activités, une perte de la vision globale de la fonction RH, ainsi qu’une perte de proximité avec les salariés peuvent en résulter. La perte de compétences dans l’entreprise peut rendre tout retour en arrière difficile et coûteux. S'ajoutent des risques liés à la sécurité et la confidentialité des données sensibles." },
                { title: "Annexe 6 : Souffrance en milieu engagé", content: "Face à la toute-puissance du marché, l'économie sociale et solidaire jouit d'une aura précieuse. Or, ce secteur est à son tour affecté par une précarité croissante. La fonction d'employeur est souvent un impensé de ces structures qui se vivent avant tout comme militantes. Très investis, les salariés peuvent avoir du mal à distinguer vie professionnelle et vie personnelle et se retrouvent, malgré eux, dans une situation de 'servitude volontaire'." }
            ];

            // --- 2. INJECTION DYNAMIQUE DU CONTENU DANS LE HTML ---
            
            // Fonction utilitaire pour formater les nombres en euros
            function formatCurrency(value) {
                if (typeof value !== 'number') return '';
                return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(value);
            }

            function buildPayslip() {
                const container = document.getElementById('payslip-container');
                if (!container) return;
                
                let html = `<div class="bg-white p-2 rounded-lg border border-gray-200">`;

                // En-tête du bulletin
                html += `<div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 p-2 border-b">`;
                Object.values(payslipData.header).forEach(item => {
                    html += `<div class="payslip-row p-1" data-id="${item.id}">
                        <span class="font-semibold">${item.label} :</span>
                        <span class="text-gray-700">${item.value}</span>
                    </div>`;
                });
                html += `</div>`;

                // Corps du bulletin (tableau des cotisations)
                html += `<div class="overflow-x-auto"><table class="w-full mt-2" style="min-width: 600px;">
                                <thead>
                                    <tr class="text-left text-gray-600">
                                        <th class="py-1 px-2 font-semibold">Libellé</th>
                                        <th class="py-1 px-2 font-semibold text-right">Base</th>
                                        <th class="py-1 px-2 font-semibold text-right">Taux Sal.</th>
                                        <th class="py-1 px-2 font-semibold text-right">Gain</th>
                                        <th class="py-1 px-2 font-semibold text-right">Retenue Sal.</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                
                payslipData.rows.forEach(row => {
                    if (row.type === 'subheader') {
                        html += `<tr><td colspan="5" class="payslip-subheader p-1">${row.label}</td></tr>`;
                    } else if (row.type === 'header') {
                         html += `<tr class="payslip-row payslip-header" data-id="${row.id}">
                            <td class="p-2" colspan="3">${row.label}</td>
                            <td class="p-2 text-right" colspan="2">${formatCurrency(row.gain)}</td>
                        </tr>`;
                    } else {
                         html += `<tr class="payslip-row" data-id="${row.id}">
                            <td class="p-1 px-2">${row.label}</td>
                            <td class="p-1 px-2 text-right">${row.base || ''}</td>
                            <td class="p-1 px-2 text-right">${row.rate_s || ''}</td>
                            <td class="p-1 px-2 text-right text-green-600">${formatCurrency(row.gain)}</td>
                            <td class="p-1 px-2 text-right text-red-600">${formatCurrency(row.deduction_s)}</td>
                         </tr>`;
                    }
                });
                html += `</tbody></table></div>`;
                
                // Pied de page du bulletin (totaux)
                const reductionGen = payslipData.rows.find(r => r.id === 'reduction_gen')?.gain || 0;
                html += `<div class="mt-4 pt-2 border-t">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1 text-sm">
                            <div class="payslip-row p-2" data-id="total_patronal">
                                <!-- CORRECTION ICI: Utilisation de .value pour accéder à la valeur numérique -->
                                <div class="flex justify-between"><span>Total cotisations patronales</span><span>${formatCurrency(payslipData.footer.total_patronal.value)}</span></div>
                            </div>
                             <div class="payslip-row p-2" data-id="reduction_gen">
                                <div class="flex justify-between"><span>Dont allègements de cotisations</span><span>- ${formatCurrency(reductionGen)}</span></div>
                            </div>
                        </div>
                        <div class="text-right">
                             <div class="payslip-row p-1" data-id="net_avant_impot">
                                <div class="flex justify-between font-bold"><span>Net à payer avant impôt</span><span>${formatCurrency(payslipData.footer.net_avant_impot.value)}</span></div>
                            </div>
                            <div class="payslip-row p-1" data-id="pas">
                                <div class="flex justify-between"><span>Impôt sur le revenu (PAS)</span><span>- ${formatCurrency(payslipData.footer.pas.montant)}</span></div>
                            </div>
                             <div class="payslip-row p-2 mt-2 bg-blue-50 rounded-md" data-id="net_a_payer">
                                <div class="flex justify-between font-bold text-lg text-blue-800"><span>NET À PAYER</span><span>${formatCurrency(payslipData.footer.net_a_payer.value)}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="payslip-row text-sm text-gray-600 mt-4 pt-2 border-t p-2" data-id="cout_total">
                        <div class="flex justify-between font-bold"><span>Coût total employeur</span><span>${formatCurrency(payslipData.footer.cout_total.value)}</span></div>
                    </div>
                     <div class="payslip-row text-sm text-gray-600 mt-2 p-2" data-id="conges">
                        <div class="flex justify-between"><span>Congés payés</span><span>Solde: ${payslipData.footer.conges.solde} jrs</span></div>
                    </div>
                </div></div>`;

                container.innerHTML = html;
            }

            function buildPyramid() {
                const container = document.getElementById('pyramid-container');
                if (!container) return;
                let html = '';
                pyramidLevels.forEach((level, index) => {
                    const width = 100 - index * 12;
                    html += `<div class="pyramid-level relative text-white text-center font-semibold p-3 ${level.color}" style="width: ${width}%;" data-text="${level.text}">
                        ${level.label}
                    </div>`;
                });
                container.innerHTML = html;
            }

            function buildAccordion() {
                const container = document.getElementById('accordion-container');
                if (!container) return;
                accordionData.forEach((item) => {
                    container.innerHTML += `
                        <div class="card overflow-hidden">
                            <h2>
                                <button class="accordion-header w-full text-left p-4 font-semibold flex justify-between items-center hover:bg-gray-50">
                                    <span>${item.title}</span>
                                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </h2>
                            <div class="accordion-content">
                                <div class="p-4 pt-0">
                                     <p class="text-gray-600">${item.content}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            // --- 3. INITIALISATION DU GRAPHIQUE (CHART.JS) ---
            function initChart() {
                const ctx = document.getElementById('payslipChart');
                if (!ctx) return;
                const { net_a_payer, total_salarial, total_patronal } = payslipData.footer;
                new Chart(ctx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Net Payé au Salarié', 'Cotisations Salariales', 'Cotisations Patronales'],
                        datasets: [{
                            data: [net_a_payer.value, total_salarial.value, total_patronal.value],
                            backgroundColor: ['#3b82f6', '#f97316', '#ef4444'], // blue, orange, red
                            borderColor: '#ffffff',
                            borderWidth: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'bottom', labels: { padding: 20 } },
                            tooltip: {
                                callbacks: { label: (context) => `${context.label}: ${formatCurrency(context.parsed)}` }
                            }
                        }
                    }
                });
            }

            // --- 4. GESTION DES INTERACTIONS UTILISATEUR ---
            function setupEventListeners() {
                const explanationBox = document.getElementById('explanation-box');
                document.body.addEventListener('click', function(e) {
                    const payslipRow = e.target.closest('.payslip-row');
                    if (payslipRow) {
                         document.querySelectorAll('.payslip-row').forEach(r => r.classList.remove('selected'));
                         payslipRow.classList.add('selected');
                         
                         const id = payslipRow.dataset.id;
                         const rowData = payslipData.rows.find(r => r.id === id);
                         const headerData = payslipData.header[id];
                         const footerData = payslipData.footer[id];
                         explanationBox.innerHTML = (rowData?.explanation || headerData?.explanation || footerData?.explanation || "Cliquez sur une autre ligne pour voir son explication.");
                    }

                    const accordionHeader = e.target.closest('.accordion-header');
                    if (accordionHeader) {
                        const content = accordionHeader.parentElement.nextElementSibling;
                        const svg = accordionHeader.querySelector('svg');
                        
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                            content.style.paddingTop = null;
                            content.style.paddingBottom = null;
                            svg.style.transform = 'rotate(0deg)';
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                            content.style.paddingTop = '0';
                            content.style.paddingBottom = '1rem';
                            svg.style.transform = 'rotate(180deg)';
                        }
                    }
                });
                
                const pyramidExplanation = document.getElementById('pyramid-explanation');
                document.getElementById('pyramid-container').addEventListener('mouseover', function(e) {
                     const pyramidLevel = e.target.closest('.pyramid-level');
                     if(pyramidLevel) {
                         pyramidExplanation.innerHTML = pyramidLevel.dataset.text;
                     }
                });
                 document.getElementById('pyramid-container').addEventListener('mouseout', function() {
                     pyramidExplanation.innerHTML = 'Survolez un niveau de la pyramide pour en savoir plus.';
                 });

            }
            
            // --- 5. OBSERVATEUR POUR LA NAVIGATION ACTIVE ---
            function setupNavObserver() {
                const sections = document.querySelectorAll('section');
                const navLinks = document.querySelectorAll('.nav-link');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            navLinks.forEach(link => {
                                link.classList.toggle('active', link.getAttribute('href').substring(1) === entry.target.id);
                            });
                        }
                    });
                }, { rootMargin: "-40% 0px -60% 0px" }); // Ajustement pour une meilleure détection
                sections.forEach(section => observer.observe(section));
            }


            // --- Lancement de l'application ---
            buildPayslip();
            buildPyramid();
            buildAccordion();
            initChart();
            setupEventListeners();
            setupNavObserver();
        });
    </script>
</body>
</html>
